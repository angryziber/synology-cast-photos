<!DOCTYPE html>
<!-- This is Chromecast receiver -->
<html>
<head>
  <title>Random photos from nas</title>
  <meta charset="utf-8">
  <style type="text/css">
    html, body {
      height: 100%;
      background: black;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    canvas {
      position: absolute;
    }
    #title, #status, #meta {
      position: absolute;
      bottom: 30px;
      width: 100%;
      color: white;
      text-shadow: 0 0 10px black;
      font-size: 16px;
    }
    #title {
      text-align: center;
      font-size: 20px;
    }
    #meta {
      opacity: 0.7;
      font-size: 14px;
      left: 50px;
      width: auto;
    }
    #status {
      opacity: 0.7;
      text-align: right;
      right: 50px;
      width: auto;
    }
  </style>
</head>

<body>
  <canvas id="img"></canvas>
  <div id="meta"></div>
  <div id="title">Waiting for commands</div>
  <div id="status"></div>
  <audio></audio>
</body>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.1.3/zepto.min.js"></script>
<script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
<script type="text/javascript">
  var photos = [], index = 0;
  var nextImg = new Image();
  var photoListUrl = '/photos_list.php';
  var photoUrlPrefix = '/photo.php?file=';
  var metaUrlPrefix = '/photo_meta.php?file=';
  var timeout = 10000;
  var $img = $('#img');
  var $title = $('#title');
  var $status = $('#status');
  var $meta = $('#meta');
  var timer, meta, loading;
  var canvas = $img[0].getContext('2d');
  var width, height;

  window.onresize = function() {
    width = $img[0].width = document.body.clientWidth;
    height = $img[0].height = document.body.clientHeight;
  };
  onresize();

  if (navigator.userAgent.indexOf('CrKey') >= 0) {
    var castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
    var castReceiverConfig = new cast.receiver.CastReceiverManager.Config();
    castReceiverConfig.maxInactivity = 60000;
    var messageBus = castReceiverManager.getCastMessageBus('urn:x-cast:message');
    messageBus.onMessage = function (e) {
      onCommand(e.data);
    };
    castReceiverManager.start(castReceiverConfig);
  }

  function broadcast(message) {
    if (messageBus) messageBus.broadcast(message);
  }

  function random(max) {
    if (window.crypto) {
      var array = new Uint32Array(1);
      crypto.getRandomValues(array);
      return array[0] % max;
    }
    else return Math.floor(Math.random()*max);
  }

  function shuffle(o) {
    for (var j, x, i = o.length; i; j = random(i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
  }

  function loadNext() {
    if (loading || !photos.length) return;
    if (index == photos.length) index = 0;

    var url = photos[index++];
    nextImg.onload = nextPhotoLoaded;
    nextImg.onerror = nextPhotoFailed;
    nextImg.src = photoUrlPrefix + url;
    meta = {};

    $.get(metaUrlPrefix + url, function(data) {
      meta = data;
//    console.log(meta);
    });
    loading = true;
    $status.text('Loading ' + index + '/' + photos.length);
  }

  function nextPhotoLoaded() {
    var url = this.src;
    $status.text('Loaded ' + index + '/' + photos.length);

    setTimeout(function() {
      showPhoto(url);
    }, 0);
  }

  function showPhoto(url) {
    var scaledHeight = height;
    var scaledWidth = nextImg.width / nextImg.height * height;
    var offsetX = -width/2 + (width - scaledWidth)/2, offsetY = -height/2;

    canvas.setTransform(1, 0, 0, 1, 0, 0);
    canvas.clearRect(0, 0, width, height);
    canvas.translate(width/2, height/2);

    function vertical() {
      canvas.scale(0.7, 0.7);
      offsetX = -height*0.72; offsetY = -width/4;
    }

    switch (meta.orientation) {
      case '3':
        canvas.rotate(Math.PI);
        break;
      case '6':
        vertical();
        canvas.rotate(Math.PI/2);
        break;
      case '8':
        vertical();
        canvas.rotate(-Math.PI/2);
        break;
      default:
        canvas.rotate(0);
        break;
    }

    canvas.drawImage(nextImg, Math.round(offsetX), Math.round(offsetY), Math.round(scaledWidth), Math.round(scaledHeight));

    $title.text(decodeURI(url.substring(url.indexOf('=') + 1, url.lastIndexOf('/'))));
    $status.text(index + '/' + photos.length);
    broadcast($title.text());
    $meta.html((meta.date || '') + '<br>' + (meta.exposure || '') + (meta.fnumber ? ', F' + eval(meta.fnumber) : ''));
    loadNextPhotoAfter(timeout);
  }

  function nextPhotoFailed() {
    $status.text(index + '/' + photos.length + ': failed');
    loadNextPhotoAfter(timeout/4);
  }

  function loadNextPhotoAfter(timeout) {
    loading = false;
    if (timer) clearTimeout(timer);
    timer = setTimeout(loadNext, timeout);
  }

  function loadPhotos(dir, random) {
    $title.text('Loading photos from ' + dir);

    $.ajax({url:photoListUrl, data:{dir: dir},
      success: function(data) {
        photos = data.trim().split('\n');
        if (random) shuffle(photos); else photos.sort();
        index = 0;
        $title.text((random ? 'Random: ' : 'Sequential: ') + dir);
        broadcast($title.text());
        $status.text(photos.length);
        loadNext();
      },
      error: function() {
        $title.text('Error: ' + arguments);
      }
    });
  }

  function onCommand(command) {
    var separatorPos = command.indexOf(':');
    if (separatorPos == -1) separatorPos = command.length;
    var cmd = command.substring(0, separatorPos);
    var arg = command.substring(separatorPos+1);
    var title = command;

    if (cmd == 'rnd') {
      loadPhotos(arg, true);
    }
    else if (cmd == 'seq') {
      loadPhotos(arg, false);
    }
    else if (cmd == 'timeout') {
      timeout = parseInt(arg)*1000;
      title = 'Timeout: ' + arg + 's';
    }
    else if (cmd == 'prev') {
      index-=2; if (index < 0) index = photos.length-1;
      setTimeout(loadNext, 0);
    }
    else if (cmd == 'next') {
      setTimeout(loadNext, 0);
    }
    else if (cmd == 'audio') {
      if (arg == 'prev') audio.prev();
      else if (arg == 'next') audio.next();
      else if (arg == 'stop') audio.stop();
      else {
        arg = arg.split('#');
        audio.addToPlaylist(arg[0], arg[1]);
        title = 'Added: ' + arg[1];
      }
    }
    else {
      loadPhotos(cmd, true);
    }

    $title.text(title);
    broadcast(title);
  }

  var audio = new (function() {
    var self = this;
    var player = $('audio')[0];
    var playlist = [];
    var playlistIndex = 0;

    self.addToPlaylist = function(url, name) {
      playlist.push({url:url, name:name});
      if (!player.src) self.play();
    };

    self.play = function() {
      player.src = playlist[playlistIndex].url;
      player.play();
      $title.text('Playing: ' + playlist[playlistIndex].name);
    };

    self.stop = function() {
      player.stop();
    };

    self.prev = function() {
      if (--playlistIndex < 0) playlistIndex = playlist.length-1;
      self.play();
    };

    self.next = function() {
      if (++playlistIndex >= playlist.length) playlistIndex = 0;
      self.play();
    };

    $(player).on('ended', self.next);
  })();

  window.onhashchange = function(e) {
    if (location.hash) onCommand(location.hash.substring(1));
  };
  window.onhashchange();
</script>
</html>

