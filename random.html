<!DOCTYPE html>
<html>
<head>
  <title>Random photos from nas</title>
  <meta charset="utf-8">
  <style type="text/css">
    html, body {
      height: 100%;
      background: black;
      margin: 0;
      font-family: sans-serif;
    }
    #img {
      position: relative;
      width: 100%;
      height: 100%;
      background-position: center center;
      background-repeat: no-repeat;
      background-size: contain;
    }
    #title {
      position: absolute;
      bottom: 30px;
      width: 100%;
      color: white;
      text-shadow: 0 0 10px black;
      text-align: center;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="img"></div>
  <div id="title">Waiting for commands</div>
</body>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.1.3/zepto.min.js"></script>
<script type="text/javascript" src="http://rawgit.com/madrobby/zepto/master/src/fx.js"></script>
<script type="text/javascript" src="http://photos.azib.net/chromecast.js"></script>
<script type="text/javascript">
  var photos = [], current = [];
  var nextImg = new Image();
  var photoUrlPrefix = '/photo.php?file=';
  var metaUrlPrefix = '/photo_meta.php?file=';
  var interval;

  function random(max) {
    if (window.crypto) {
      var array = new Uint32Array(1);
      crypto.getRandomValues(array);
      return array[0] % max;
    }
    else return parseInt(Math.random()*max);
  }

  function loadRandom() {
    if (current.length == 0) current = photos.slice(0);
    if (current.length == 0) return;

    var url = current.splice(random(current.length), 1)[0];
    nextImg.src = photoUrlPrefix + url;
    var orientation = 1;

    $.get(metaUrlPrefix + url, function(meta) {
      orientation = meta.orientation;
      console.log(meta);
    });

    nextImg.onload = function() {
      var img = $('#img');
      img.css({'background-image': 'none', '-webkit-transform': 'none'});
      var css = {'background-image': 'url(' + this.src + ')'};
      switch (orientation) {
        case '3': css['-webkit-transform'] = 'rotate(180deg)'; css.height = '100%'; css.top = 0; break;
        case '6': css['-webkit-transform'] = 'rotate(90deg)'; css.height = '67%'; css.top = '17%'; break;
        case '8': css['-webkit-transform'] = 'rotate(270deg)'; css.height = '67%'; css.top = '17%'; break;
        default: css['-webkit-transform'] = 'none';  css.height = '100%'; css.top = 0; break;
      }
      img.css(css);

      setTimeout(function() {
        $('#title').text(url.substring(0, url.lastIndexOf('/')));
      }, 1000);
    };
    console.log('Shown ' + (photos.length - current.length) + ' of ' + photos.length);
  }

  function loadPhotos(dir) {
    $('#title').text('Loading photos from ' + dir);
    if (interval) clearInterval(interval);

    $.ajax({url:'photos_list.php', data:{dir: dir},
      success: function(data) {
        photos = data.trim().split('\n');
        current = [];
        $('#title').text(dir + ': ' + photos.length);

        loadRandom();
        interval = setInterval(loadRandom, 10000);
      },
      error: function() {
        $('#title').text('Error: ' + arguments);
      }
    });
  }

  document.addEventListener('message', function(e) {
    loadPhotos(e.detail);
  });
  
  window.onhashchange = function(e) {
    if (location.hash) loadPhotos(location.hash.substring(1));
  };
  window.onhashchange();
</script>
</html>

