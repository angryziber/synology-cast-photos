<!DOCTYPE html>
<!-- This is Chromecast sender -->
<html>
<head>
  <title>Cast NAS photos</title>
  <meta charset="utf-8">
  <style type="text/css">
    @import 'http://twitter.github.io/typeahead.js/css/examples.css';
    .tt-dropdown-menu {
      max-height: 300px;
      overflow-y: auto;
    }

    button {
      font-size: 24px;
      line-height: 30px;
      position: relative;
      top: 15px;
      padding: 8px;
      border-radius: 8px;
      border: 2px solid #b8b8b8;
    }

    #last-cmd {
      margin-top: 20px;
      color: red;
    }
  </style>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="http://photos.azib.net/chromecast.js"></script>
  <script type="text/javascript" src="http://twitter.github.io/typeahead.js/releases/0.10.2/typeahead.jquery.js"></script>
</head>
<body>
<div class="container">
  <div class="demo">
    Send photos from NAS to Chromecast!<br><br>

    <form>
      <input class="typeahead" type="text" name="prefix" value="" placeholder="2014" autofocus>
      <br>

      <div style="margin-top: 20px">
        <label><input type="checkbox" name="random" checked> Random</label>
      </div>

      <div style="margin-top: 20px">
        Timeout: <input type="number" name="timeout" value="10" min="0" style="width: 50px"> s
      </div>

      <button type="button" id="prev-more">&lt;&lt;</button>
      <button type="button" id="prev">&lt;</button>
      <button type="button" id="next">&gt;</button>
      <button type="button" id="next-more">&gt;&gt;</button>

      <div style="margin-top: 100px">
        <input type="text" class="typeahead" name="audio" placeholder="Search VK Music">
        <br>
        <button type="button" id="audio-prev">&lt;</button>
        <button type="button" id="audio-stop">Stop</button>
        <button type="button" id="audio-next">&gt;</button>
      </div>
    </form>
    <br>
    <div id="last-cmd"></div>
  </div>
</div>
</body>
<script type="text/javascript">
  chromecast.appId = location.host.indexOf('192.168.') >= 0 || location.host.indexOf('.local') >= 0 ? '40FA4E04' : '87673D37';
  chromecast.onMessage(function(cmd) {
    console.log(cmd);
  });
  setTimeout(chromecast.launch, 1000);

  var tv = new (function() {
    var self = this;

    var input = $('[name=prefix]');
    var random = $('[name=random]');
    var timeout = $('[name=timeout]');

    input.typeahead({hint: true, highlight: true, minLength: 3}, {
      name: 'photo-dirs',
      displayKey: 'dir',
      source: function (dir, cb) {
        $.get('/photos_dirs.php?dir=' + dir, function (data) {
          var values = data.trim().split('\n');
          cb($.map(values, function (value) {
            return {dir: value};
          }));
        });
      }
    });

    function sendCommand(cmd) {
      chromecast.message(cmd);
      $('#last-cmd').text(cmd).show().fadeOut(2000);
    }

    self.sendPhotoDir = function() {
      sendCommand((random.is(':checked') ? 'rnd:' : 'seq:') + input.val());
    };

    self.sendAudio = function(url, name) {
      sendCommand('audio:' + url + (name ? '#' + name : ''));
    };

    input.on('typeahead:selected', self.sendPhotoDir);
    input.closest('form').on('submit', function() {
      self.sendPhotoDir();
      return false;
    });

    random.on('click', function() {
      if (input.val()) self.sendPhotoDir();
    });

    timeout.on('change', function() {
      sendCommand('timeout:' + timeout.val());
    });

    $('#prev').on('click', function() {
      sendCommand('prev');
    });

    $('#next').on('click', function() {
      sendCommand('next');
    });

    $('#prev-more').on('click', function() {
      sendCommand('prev:10');
    });

    $('#next-more').on('click', function() {
      sendCommand('next:10');
    });
  })();

  var vk = new (function() {
    var self = this;

    var vkToken = localStorage['vkToken'];
    var input = $('[name=audio]');

    self.tokenCallback = function(token) {
      vkToken = localStorage['vkToken'] = token;
    };

    function newToken(callback) {
      window.open('https://oauth.vk.com/authorize?client_id=4774342&scope=audio&redirect_uri=' +
                  location.href.replace('/cast.html', '/vk-callback.html') + '&display=popup&v=5.28&response_type=token', 'width=640,height=480');
    }

    function handleError(e) {
      console.log(e);
      if (e.error_code == 6) // too many rps
        return;
      if (e.error_code == 5) // token expired
        newToken();
      else
        alert(e.error_msg);
    }

    input.on('focus', function() {
      if (!vkToken)
        newToken();
    });

    input.typeahead({hint: true, highlight: true, minLength: 5}, {
      name: 'vk-audio',
      displayKey: 'name',
      source: function (q, cb) {
        $.getJSON('https://api.vk.com/method/audio.search?q=' + q + '&access_token=' + vkToken + '&auto_complete=true&callback=?', function(data) {
          if (data.error) {
            handleError(data.error);
            return;
          }

          data.response.shift();
          cb($.map(data.response, function (item) {
            return {name: item.artist + ' - ' + item.title, url: item.url.replace(/\?extra.*/, '')}
          }));
        });
      }
    });

    input.on('typeahead:selected', function(e, item) {
      tv.sendAudio(item.url, item.name);
    });

    $('#audio-stop').on('click', function() {
      tv.sendAudio('stop');
    });

    $('#audio-prev').on('click', function() {
      tv.sendAudio('prev');
    });

    $('#audio-next').on('click', function() {
      tv.sendAudio('next');
    });
  })();
</script>
</html>

